'use client'

import type { Vulnerability } from '@prisma/client'
import { Card, CardContent } from '@/components/ui/Card'
import Badge from '@/components/ui/Badge'

interface VulnerabilityCardProps {
  vulnerability: Vulnerability
}

export default function VulnerabilityCard({ vulnerability }: VulnerabilityCardProps) {
  const getSeverityVariant = (severity: string): 'critical' | 'high' | 'medium' | 'low' | 'default' => {
    switch (severity.toLowerCase()) {
      case 'critical': return 'critical'
      case 'high': return 'high'
      case 'medium': return 'medium'
      case 'low': return 'low'
      default: return 'default'
    }
  }

  const getConfidenceVariant = (confidence: string): 'success' | 'medium' | 'critical' | 'default' => {
    switch (confidence.toLowerCase()) {
      case 'high': return 'success'
      case 'medium': return 'medium'
      case 'low': return 'critical'
      default: return 'default'
    }
  }

  const getSeverityIcon = (severity: string) => {
    switch (severity.toLowerCase()) {
      case 'critical':
        return (
          <svg className="h-6 w-6 text-severity-critical" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        )
      case 'high':
        return (
          <svg className="h-6 w-6 text-orange-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        )
      case 'medium':
        return (
          <svg className="h-6 w-6 text-severity-medium" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        )
      case 'low':
        return (
          <svg className="h-6 w-6 text-severity-low" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        )
      default:
        return (
          <svg className="h-6 w-6 text-cyber-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        )
    }
  }

  // Get OWASP Top 10 link based on owaspId
  const getOwaspLink = (owaspId: string | null) => {
    if (!owaspId) return null

    // Map OWASP categories to their documentation URLs (2025)
    const owaspLinks: Record<string, string> = {
      'A01:2025': 'https://owasp.org/Top10/A01_2025-Broken_Access_Control/',
      'A02:2025': 'https://owasp.org/Top10/A02_2025-Security_Misconfiguration/',
      'A03:2025': 'https://owasp.org/Top10/A03_2025-Software_Supply_Chain_Failures/',
      'A04:2025': 'https://owasp.org/Top10/A04_2025-Cryptographic_Failures/',
      'A05:2025': 'https://owasp.org/Top10/A05_2025-Injection/',
      'A06:2025': 'https://owasp.org/Top10/A06_2025-Insecure_Design/',
      'A07:2025': 'https://owasp.org/Top10/A07_2025-Authentication_Failures/',
      'A08:2025': 'https://owasp.org/Top10/A08_2025-Software_and_Data_Integrity_Failures/',
      'A09:2025': 'https://owasp.org/Top10/A09_2025-Security_Logging_and_Alerting_Failures/',
      'A10:2025': 'https://owasp.org/Top10/A10_2025-Mishandling_of_Exceptional_Conditions/',
    }

    return owaspLinks[owaspId] || 'https://owasp.org/Top10/'
  }

  const severityBorderClass = {
    critical: 'border-l-severity-critical',
    high: 'border-l-orange-500',
    medium: 'border-l-severity-medium',
    low: 'border-l-severity-low',
    default: 'border-l-cyber-gray-700',
  }[getSeverityVariant(vulnerability.severity)]

  return (
    <Card variant="bordered" className={`border-l-4 ${severityBorderClass}`}>
      <CardContent>
        <div className="flex items-start justify-between mb-4">
          <div className="flex items-start space-x-3 flex-1">
            <div className="mt-1">{getSeverityIcon(vulnerability.severity)}</div>
            <div className="flex-1 min-w-0">
              <h3 className="text-lg font-semibold text-foreground">
                {vulnerability.type}
              </h3>
              <p className="text-sm text-cyber-gray-400 mt-1.5">
                {vulnerability.description}
              </p>
              {vulnerability.owaspCategory && (
                <div className="mt-3 flex items-center gap-2 flex-wrap">
                  <Badge variant="info" size="sm">
                    <svg className="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                    </svg>
                    OWASP {vulnerability.owaspId}
                  </Badge>
                  {getOwaspLink(vulnerability.owaspId) && (
                    <a
                      href={getOwaspLink(vulnerability.owaspId)!}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="inline-flex items-center text-xs text-cyber-blue-light hover:text-cyber-blue transition-colors"
                    >
                      Learn more
                      <svg className="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                      </svg>
                    </a>
                  )}
                </div>
              )}
            </div>
          </div>
          <div className="flex flex-col items-end gap-2 ml-4 shrink-0">
            <Badge variant={getSeverityVariant(vulnerability.severity)} size="md">
              {vulnerability.severity}
            </Badge>
            <Badge
              variant={getConfidenceVariant(vulnerability.confidence)}
              size="sm"
              className="text-xs"
            >
              {vulnerability.confidence} Confidence
            </Badge>
          </div>
        </div>

        <div className="space-y-3 mt-4">
          <div>
            <h4 className="text-xs font-semibold text-cyber-gray-400 uppercase tracking-wider mb-2 flex items-center gap-2">
              <svg className="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              {vulnerability.location.includes('\n\n') ? 'Locations' : 'Location'}
            </h4>
            {vulnerability.location.includes('\n\n') ? (
              <div className="space-y-2">
                {vulnerability.location.split('\n\n').map((loc, idx) => (
                  <div key={idx} className="flex items-start gap-2">
                    <span className="text-xs font-mono text-cyber-gray-500 mt-1 shrink-0">#{idx + 1}</span>
                    <p className="text-sm text-cyber-gray-300 font-mono bg-cyber-darker border border-cyber-gray-700 p-3 rounded flex-1 break-all">
                      {loc.trim()}
                    </p>
                  </div>
                ))}
              </div>
            ) : (
              <p className="text-sm text-cyber-gray-300 font-mono bg-cyber-darker border border-cyber-gray-700 p-3 rounded break-all">
                {vulnerability.location}
              </p>
            )}
          </div>

          <div>
            <h4 className="text-xs font-semibold text-cyber-gray-400 uppercase tracking-wider mb-2 flex items-center gap-2">
              <svg className="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
              </svg>
              Remediation
            </h4>
            <p className="text-sm text-cyber-gray-300 bg-cyber-blue/10 border border-cyber-blue/30 p-3 rounded leading-relaxed">
              {vulnerability.remediation}
            </p>
          </div>
        </div>
      </CardContent>
    </Card>
  )
}
